{% extends 'base.html' %}

{% block content %}
{% include 'inventory/inventory_navbar.html' %}
<div>
    <h1>
        Suppliers
        <button class="btn btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#addSupplierModal" title="Add Supplier" style="padding: 0.5rem; border-radius: 50%; margin-left: 1rem;">
            <i class="fas fa-plus"></i>
        </button>
    </h1>

    <!-- Search Bar -->
    <form class="mb-3">
        <input type="text" id="supplierSearch" placeholder="Search suppliers" class="form-control rounded-search">
    </form>

    <!-- Supplier Table -->
    <table class="table table-hover table-striped" id="supplierTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">ID <i class="fas fa-sort"></i></th>
                <th onclick="sortTable(1)">Supplier <i class="fas fa-sort"></i></th>
                <th onclick="sortTable(2)">Contact Person <i class="fas fa-sort"></i></th>
                <th>Phone</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for supplier in page_obj %}
            <tr onclick="redirectToSupplierView('{{ supplier.supplier_id }}')">
                <td>{{ supplier.supplier_id }}</td>
                <td>{{ supplier.name }}</td>
                <td>{{ supplier.contact_person }}</td>
                <td>{{ supplier.phone }}</td>
                <td>{{ supplier.email }}</td>
                <td>
                    <a href="{% url 'edit_supplier' supplier.supplier_id %}" class="btn btn-primary btn-sm">Edit</a>
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteSupplierModal" onclick="openDeleteSupplierModal('{{ supplier.supplier_id }}'); event.stopPropagation();">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div class="d-flex justify-content-center">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if query %}&q={{ query }}{% endif %}" class="btn btn-outline-secondary">&laquo; First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-outline-secondary">Previous</a>
        {% endif %}

        <span class="mx-2 align-self-center">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-outline-secondary">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-outline-secondary">Last &raquo;</a>
        {% endif %}
    </div>
</div>

<!-- Add Supplier Modal -->
<div id="addSupplierModal" class="modal fade" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addSupplierModalLabel">Add Supplier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_supplier' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_name" class="form-label">Name</label>
                        <input type="text" name="name" id="id_name" class="form-control" placeholder="Supplier Name" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_contact_person" class="form-label">Contact Person</label>
                        <input type="text" name="contact_person" id="id_contact_person" class="form-control" placeholder="Contact Person">
                    </div>
                    <div class="mb-3">
                        <label for="id_phone" class="form-label">Phone</label>
                        <input type="text" name="phone" id="id_phone" class="form-control" placeholder="Phone Number">
                    </div>
                    <div class="mb-3">
                        <label for="id_email" class="form-label">Email</label>
                        <input type="email" name="email" id="id_email" class="form-control" placeholder="Email Address">
                    </div>
                    <div class="mb-3">
                        <label for="id_address" class="form-label">Address</label>
                        <textarea name="address" id="id_address" class="form-control" placeholder="Supplier Address"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="id_city" class="form-label">City</label>
                        <input type="text" name="city" id="id_city" class="form-control" placeholder="City">
                    </div>
                    <div class="mb-3">
                        <label for="id_country" class="form-label">Country</label>
                        <input type="text" name="country" id="id_country" class="form-control" placeholder="Country">
                    </div>
                    <div class="mb-3">
                        <label for="id_notes" class="form-label">Notes</label>
                        <textarea name="notes" id="id_notes" class="form-control" placeholder="Additional Notes"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Add Supplier</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Supplier Modal -->
<div id="deleteSupplierModal" class="modal fade" tabindex="-1" aria-labelledby="deleteSupplierModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteSupplierModalLabel">Delete Supplier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this supplier?</p>
                <form id="deleteSupplierForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger w-100">Yes, Delete</button>
                    <button type="button" class="btn btn-secondary w-100 mt-2" data-bs-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Redirect to View Supplier page
    function redirectToSupplierView(supplierId) {
        window.location.href = `/suppliers/view/${supplierId}/`;
    }

    // Sort table columns
    function sortTable(columnIndex) {
        const table = document.getElementById("supplierTable");
        const rows = Array.from(table.rows).slice(1);
        const sortedRows = rows.sort((rowA, rowB) => {
            const cellA = rowA.cells[columnIndex].innerText.toLowerCase();
            const cellB = rowB.cells[columnIndex].innerText.toLowerCase();
            return cellA.localeCompare(cellB);
        });

        const tbody = table.querySelector("tbody");
        sortedRows.forEach(row => tbody.appendChild(row));
    }

    // Live search functionality
    document.getElementById('supplierSearch').addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#supplierTable tbody tr");

        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(filter) ? "" : "none";
        });
    });

    // Delete Supplier Modal
    function openDeleteSupplierModal(supplierId) {
        document.getElementById('deleteSupplierForm').action = `/suppliers/${supplierId}/delete/`;
    }
</script>
{% endblock %}
