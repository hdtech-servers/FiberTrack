{% extends 'base.html' %}

{% block title %}Expenses{% endblock %}

{% block content %}
        {% include 'expenses/expenses_navbar.html' %}

<div >
    <h1>Expenses
        <button style="padding: 0.5rem; border-radius: 50%;" class="btn btn-success mb-3" data-toggle="modal" data-target="#addExpenseModal"><i class="fas fa-plus"></i></button>

    </h1>

    <!-- Filters (e.g., search and date range) -->
    <div class="row mb-4">
        <div class="col-md-4">
            <input type="text" class="form-control" id="expenseSearch" placeholder="Search Expenses...">
        </div>
        <div class="col-md-4">
            <input type="date" class="form-control" id="startDate" placeholder="Start Date">
        </div>
        <div class="col-md-4">
            <input type="date" class="form-control" id="endDate" placeholder="End Date">
        </div>
    </div>

    <!-- Expense Table -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Payment Method</th>
                    <th>Supplier</th>
                    <th>Receipt</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="expenseTableBody">
                {% for expense in expenses %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ expense.date }}</td>
                    <td>{{ expense.category.name }}</td>
                    <td>{{ expense.description }}</td>
                    <td>{{ expense.amount }}</td>
                    <td>{{ expense.payment_method }}</td>
                    <td>{{ expense.supplier }}</td>
                    <td>
                        {% if expense.receipt %}
                            <a href="{{ expense.receipt.url }}" target="_blank">View Receipt</a>
                        {% else %}
                            No Receipt
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-warning" data-toggle="modal" data-target="#editExpenseModal{{ expense.id }}">Edit</button>
                        <button class="btn btn-danger" data-toggle="modal" data-target="#deleteExpenseModal{{ expense.id }}">Delete</button>
                    </td>
                </tr>

                <!-- Edit Expense Modal -->
                <div class="modal fade" id="editExpenseModal{{ expense.id }}" tabindex="-1" role="dialog" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <form method="POST" action="{% url 'edit_expense' expense.id %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editExpenseModalLabel">Edit Expense</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label for="date">Date</label>
                                        <input type="date" class="form-control" name="date" value="{{ expense.date }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="category">Category</label>
                                        <select class="form-control" name="category" required>
                                            {% for category in categories %}
                                            <option value="{{ category.id }}" {% if category.id == expense.category.id %}selected{% endif %}>{{ category.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="description">Description</label>
                                        <textarea class="form-control" name="description" required>{{ expense.description }}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="amount">Amount</label>
                                        <input type="number" step="0.01" class="form-control" name="amount" value="{{ expense.amount }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="payment_method">Payment Method</label>
                                        <select class="form-control" name="payment_method" required>
                                            <option value="Cash" {% if expense.payment_method == "Cash" %}selected{% endif %}>Cash</option>
                                            <option value="Credit" {% if expense.payment_method == "Credit" %}selected{% endif %}>Credit</option>
                                            <option value="Bank Transfer" {% if expense.payment_method == "Bank Transfer" %}selected{% endif %}>Bank Transfer</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="supplier">Supplier</label>
                                        <input type="text" class="form-control" name="supplier" value="{{ expense.supplier }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="receipt">Receipt</label>
                                        <input type="file" class="form-control" name="receipt">
                                        {% if expense.receipt %}
                                            <a href="{{ expense.receipt.url }}" target="_blank">View Existing Receipt</a>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Delete Expense Modal -->
                <div class="modal fade" id="deleteExpenseModal{{ expense.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteExpenseModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <form method="POST" action="{% url 'delete_expense' expense.id %}">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteExpenseModalLabel">Delete Expense</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <p>Are you sure you want to delete this expense?</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger">Delete</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Add Expense</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="expenseFormModal" method="post" action="{% url 'add_expense' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="date">Date:</label>
                            <input type="date" name="date" id="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="description">Description:</label>
                            <textarea name="description" id="description" class="form-control" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="category">Category:</label>
                            <select name="category" id="category" class="form-control" required>
                                <option value="">Select a Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">Amount:</label>
                            <input type="number" step="0.01" name="amount" id="amount" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="payment_method">Payment Method:</label>
                            <select name="payment_method" id="payment_method" class="form-control" required>
                                <option value="Cash">Cash</option>
                                <option value="Credit">Credit</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="supplier">Supplier:</label>
                            <input type="text" name="supplier" id="supplier" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="receipt">Receipt (Optional):</label>
                            <input type="file" name="receipt" id="receipt" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-success btn-block">Add Expense</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Handle form submission inside the modal
        $('#expenseFormModal').on('submit', function(e) {
            e.preventDefault();  // Prevent default form submission behavior
            var form = $(this);
            var url = form.attr('action');  // Ensure the URL is correct
            var formData = new FormData(this);  // Use FormData to include file uploads

            $.ajax({
                type: "POST",
                url: url,
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        // Close the modal
                        $('#addExpenseModal').modal('hide');
                        location.reload();  // Reload the page to reflect the new expense
                    } else {
                        var errorMessages = response.errors;
                        $('#expenseFormModal .error-message').remove();  // Remove any previous errors
                        for (var field in errorMessages) {
                            $('#expenseFormModal [name=' + field + ']').after(
                                '<p class="error-message text-danger">' + errorMessages[field].join(', ') + '</p>'
                            );
                        }
                    }
                },
                error: function(response) {
                    alert('An error occurred. Please try again.');
                }
            });
        });
    });
</script>
{% endblock %}
